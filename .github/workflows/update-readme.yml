name: Update Profile README with Dependencies Stats

on:
  schedule:
    - cron: '0 0 * * 0' # –ó–∞–ø—É—Å–∫ —â–æ–Ω–µ–¥—ñ–ª—ñ –æ 00:00 UTC
  workflow_dispatch: # –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –∑–∞–ø—É—Å–∫—É –≤—Ä—É—á–Ω—É

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Fetch all repositories
      run: |
        echo "## üì¶ –ú–æ—ó —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó" > REPOSITORIES.md
        echo "" >> REPOSITORIES.md
        curl -s "https://api.github.com/users/VorobeiIvan/repos?per_page=100" | jq -r '.[] | "- [\(.name)](\(.html_url)): \(.description // "–û–ø–∏—Å –≤—ñ–¥—Å—É—Ç–Ω—ñ–π")"' >> REPOSITORIES.md

    - name: Analyze dependencies and calculate stats
      run: |
        declare -A dependencies
        total_repos=0

        # –û—Ç—Ä–∏–º—É—î–º–æ —Å–ø–∏—Å–æ–∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤
        for repo in $(curl -s "https://api.github.com/users/VorobeiIvan/repos?per_page=100" | jq -r '.[].name'); do
          total_repos=$((total_repos + 1))
          # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å package.json
          package_json=$(curl -s "https://raw.githubusercontent.com/VorobeiIvan/$repo/main/package.json")
          if [ "$package_json" != "404: Not Found" ]; then
            # –í–∏—Ç—è–≥—É—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
            echo "$package_json" | jq -r '.dependencies, .devDependencies | to_entries[] | .key' | while read -r dependency; do
              dependencies["$dependency"]=$((dependencies["$dependency"] + 1))
            done
          fi
        done

        # –ì–µ–Ω–µ—Ä—É—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        echo "## üìö –£–∑–∞–≥–∞–ª—å–Ω–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π" >> REPOSITORIES.md
        for dependency in "${!dependencies[@]}"; do
          usage=${dependencies[$dependency]}
          percent=$(echo "scale=2; ($usage / $total_repos) * 100" | bc)
          echo "- $dependency: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ $usage —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—è—Ö ($percent%)" >> REPOSITORIES.md
        done

    - name: Update README.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cat REPOSITORIES.md >> README.md
        git config --global user.name "GitHub Action"
        git config --global user.email "actions@github.com"
        git add README.md
        git commit -m "–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è README.md —ñ–∑ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—è–º–∏"
        git push