- name: Fetch all repositories and analyze dependencies
run: |
  declare -A dependencies
  total_repos=0

  # –û—Ç—Ä–∏–º—É—î–º–æ —Å–ø–∏—Å–æ–∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤
  for repo in $(curl -s "https://api.github.com/users/VorobeiIvan/repos?per_page=100" | jq -r '.[].name'); do
    echo "–ê–Ω–∞–ª—ñ–∑—É—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π: $repo"
    total_repos=$((total_repos + 1))

    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ package.json (npm)
    package_json=$(curl -s "https://raw.githubusercontent.com/VorobeiIvan/$repo/main/package.json")
    if [ "$package_json" != "404: Not Found" ] && [ -n "$package_json" ]; then
      echo "–ó–Ω–∞–π–¥–µ–Ω–æ package.json —É $repo"
      echo "$package_json" | jq -r '.dependencies, .devDependencies | to_entries[] | .key' | while read -r dependency; do
        dependencies["$dependency"]=$((dependencies["$dependency"] + 1))
      done
    fi

    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ yarn.lock (Yarn)
    yarn_lock=$(curl -s "https://raw.githubusercontent.com/VorobeiIvan/$repo/main/yarn.lock")
    if [ "$yarn_lock" != "404: Not Found" ] && [ -n "$yarn_lock" ]; then
      echo "–ó–Ω–∞–π–¥–µ–Ω–æ yarn.lock —É $repo"
      echo "$yarn_lock" | grep -oP '^[^#\s][^@]+' | while read -r dependency; do
        dependencies["$dependency"]=$((dependencies["$dependency"] + 1))
      done
    fi

    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ pyproject.toml (Poetry)
    pyproject_toml=$(curl -s "https://raw.githubusercontent.com/VorobeiIvan/$repo/main/pyproject.toml")
    if [ "$pyproject_toml" != "404: Not Found" ] && [ -n "$pyproject_toml" ]; then
      echo "–ó–Ω–∞–π–¥–µ–Ω–æ pyproject.toml —É $repo"
      echo "$pyproject_toml" | grep -oP '^\s*[a-zA-Z0-9_-]+(?=\s*=\s*".*")' | while read -r dependency; do
        dependencies["$dependency"]=$((dependencies["$dependency"] + 1))
      done
    fi

    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ requirements.txt (Python)
    requirements_txt=$(curl -s "https://raw.githubusercontent.com/VorobeiIvan/$repo/main/requirements.txt")
    if [ "$requirements_txt" != "404: Not Found" ] && [ -n "$requirements_txt" ]; then
      echo "–ó–Ω–∞–π–¥–µ–Ω–æ requirements.txt —É $repo"
      echo "$requirements_txt" | grep -oP '^[a-zA-Z0-9_-]+' | while read -r dependency; do
        dependencies["$dependency"]=$((dependencies["$dependency"] + 1))
      done
    fi
  done

  # –ì–µ–Ω–µ—Ä—É—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
  echo "## üìö –£–∑–∞–≥–∞–ª—å–Ω–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π" > REPOSITORIES.md
  for dependency in "${!dependencies[@]}"; do
    usage=${dependencies[$dependency]}
    percent=$(echo "scale=2; ($usage / $total_repos) * 100" | bc)
    echo "- $dependency: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ $usage —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—è—Ö ($percent%)" >> REPOSITORIES.md
  done

  # –í–∏–≤–æ–¥–∏–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
  cat REPOSITORIES.md